{% extends "base.html" %}

{% block title %}Задача{% endblock title %}

{% block links %}
    <link rel="stylesheet" href="/static/task.css">
{% endblock links %}


{% block content %}
    <h1>Задача</h1>

    {% if context.user and not context.error and context.task %}
        <div class="task-block">
            <p><b>Описание: </b>{{ context.task.description }}</p>
            <p><b>Дедлайн: </b>{{ context.task.deadline }}</p>
            <p><b>Статус: </b>{{ context.task.status }}</p>
            <p><b>ID исполнителя: </b>{{ context.task.performer_id }}</p>
            {% if context.task.evaluation %}
                <p><b>Оценка: </b>{{ context.task.evaluation }}</p>
            {% endif %}
        </div>

        {% if context.role in ["Админ", "Менеджер"] %}
            <form id="update-task-form" class="page-form">
                <h2>Изменить задачу</h2>

                <div class="input-block">
                    <label for="description-input">Описание:</label>
                    <input type="text" name="description" id="description-input">
                </div>

                <div class="input-block">
                    <label for="deadline-input">Дедлайн:</label>
                    <input type="date" name="deadline" id="deadline-input">
                </div>

                <div class="input-block">
                    <label for="performer-id-input">ID исполнителя:</label>
                    <input type="text" name="performer_id" id="performer-id-input">
                </div>

                <div class="input-block">
                    <label for="status-select">Статус:</label>
                    <select name="status" id="status-select">
                        <option value="">Не выбрано</option>
                        <option value="o">Открыта</option>
                        <option value="w">В работе</option>
                        <option value="c">Завершена</option>
                    </select>
                </div>

                <button class="form-btn">Отправить</button>

                <script>
                    document.getElementById("update-task-form").addEventListener("submit", async (event) => {
                        event.preventDefault();

                        const token = document.cookie
                            .split("; ")
                            .find(row => row.startsWith("access_token="))
                            ?.split("=")[1];

                        const form_data = new FormData(event.target);
                        const data = Object.fromEntries(form_data);

                        Object.keys(data).forEach((key) => {
                            if (data[key] === "" || data[key] == null) {
                                delete data[key];
                            }
                        });

                        try {
                            const response = await fetch("/api/teams/{{ context.team_id }}/tasks/{{ context.task_id }}", {
                                method: "PUT",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${token}`,
                                },                            
                                body: JSON.stringify(data),
                            });

                            if (response.ok) {
                                window.location.reload();
                            } else {
                                alert("Ошибка при обновлении данных");
                            }
                        } catch {
                            alert("Ошибка сети");
                        }
                    });
                </script>
            </form>

            <form id="update-evaluation-form" class="page-form">
                <h2>Поставить оценку</h2>

                <div class="input-block">
                    <label for="value-input">Оценка (от 1 до 5):</label>
                    <input type="text" name="value" required id="value-input">
                </div>

                <button class="form-btn">Отправить</button>

                <script>
                    document.getElementById("update-evaluation-form").addEventListener("submit", async (event) => {
                        event.preventDefault();

                        const token = document.cookie
                            .split("; ")
                            .find(row => row.startsWith("access_token="))
                            ?.split("=")[1];

                        const form_data = new FormData(event.target);
                        const data = Object.fromEntries(form_data);

                        try {
                            const response = await fetch("/api/teams/{{ context.team_id }}/tasks/{{ context.task_id }}/evaluation", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${token}`,
                                },
                                body: JSON.stringify(data),
                            });

                            if (response.ok) {
                                window.location.reload();
                            } else {
                                alert("Ошибка при обновлении оценки");
                            }
                        } catch {
                            alert("Ошибка сети");
                        }
                    });

                </script>
            </form>

            <form id="delete-task-form" class="page-form">
                <h2>Удалить Задачу</h2>
                <button class="form-btn">Удалить</button>

                <script>
                    document.getElementById("delete-task-form").addEventListener("submit", async (event) => {
                        event.preventDefault();

                        const token = document.cookie
                            .split("; ")
                            .find(row => row.startsWith("access_token="))
                            ?.split("=")[1];

                        try {
                            const response = await fetch("/api/teams/{{ context.team_id }}/tasks/{{ context.task_id }}", {
                                method: "DELETE",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${token}`,
                                },                            
                            });

                            if (response.ok) {
                                window.location.href = "/teams/{{ context.team_id }}";
                            } else {
                                alert("Ошибка при удалении задачи");
                            }
                        } catch {
                            alert("Ошибка сети");
                        }
                    });              
                </script>
            </form>
        {% endif %}

        <form id="add-comment-form" class="page-form">
            <h2>Написать комментарий</h2>

            <div class="input-block">
                <label for="text-input">Текст:</label>
                <input type="text" name="text" required id="text-input">
            </div>

            <button class="form-btn">Отправить</button>

            <script>
                document.getElementById("add-comment-form").addEventListener("submit", async (event) => {
                    event.preventDefault();

                    const token = document.cookie
                        .split("; ")
                        .find(row => row.startsWith("access_token="))
                        ?.split("=")[1];

                    const form_data = new FormData(event.target);
                    const data = Object.fromEntries(form_data);

                    try {
                        const response = await fetch("/api/teams/{{ context.team_id }}/tasks/{{ context.task_id }}/comments", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${token}`,
                            },
                            body: JSON.stringify(data),
                        });

                        if (response.ok) {
                            window.location.reload();
                        } else {
                            alert("Ошибка при отправке комметария");
                        }
                    } catch {
                        alert("Ошибка сети");
                    }
                });
            </script>
        </form>

        {% if context.comments %}
            <h2>Комментарии</h2>

            <div class="comments">
                {% for comment in context.comments %}
                    <form class="delete-comment-form" data-comment-id="{{ comment.id }}">
                        <div class="comment-block">
                            <p>Текст: <b>{{ comment.text }}</b></p>
                            <p>ID отправителя: <b>{{ comment.user_id }}</b></p>
                        </div>

                        {% if comment.user_id == context.user.id %}
                            <button class="form-btn">Удалить</button>
                        {% endif %}
                    </form>  
                {% endfor %}

                <script>
                    document.querySelectorAll(".delete-comment-form").forEach(form => {
                        form.addEventListener("submit", async (event) => {
                            event.preventDefault();

                            const token = document.cookie
                                .split("; ")
                                .find(row => row.startsWith("access_token="))
                                ?.split("=")[1];

                            const comment_id = form.dataset.commentId;

                            try {
                                const response = await fetch(`/api/teams/{{ context.team_id }}/tasks/{{ context.task_id }}/comments/${comment_id}`, {
                                    method: "DELETE",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "Authorization": `Bearer ${token}`,
                                    },
                                });

                                if (response.ok) {
                                    window.location.reload();
                                } else {
                                    alert("Ошибка при удалении комментария");
                                }
                            } catch {
                                alert("Ошибка сети");
                            }
                        });
                    });
                </script>
            </div>
        {% else %}
            <h2>Комментариев нет</h2>
        {% endif %}

    {% else %}
        <script>
            (() => {
                document.location.href = "/";
            })();
        </script>
    {% endif %}

{% endblock content %}
